@model EasyGames.Models.Product
@{
    ViewData["Title"] = Model.Name;
    var img = string.IsNullOrWhiteSpace(Model.ImageUrl)
        ? "https://via.placeholder.com/900x650?text=EasyGames"
        : Model.ImageUrl;
    var inStock = Model.Stock > 0;
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="my-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-controller="Shop" asp-action="Index">Shop</a></li>
        @if (!string.IsNullOrWhiteSpace(Model.Category))
        {
            <li class="breadcrumb-item">
                <a asp-controller="Shop" asp-action="Index" asp-route-category="@Model.Category">@Model.Category</a>
            </li>
        }
        <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
    </ol>
</nav>

<div class="row g-4 align-items-start">
    <!-- Left: Image -->
    <div class="col-12 col-lg-6">
        <div class="border rounded-3 p-2 bg-white">
            <img src="@img" class="img-fluid rounded-3 w-100" style="object-fit:cover; max-height:560px;" alt="@Model.Name" />
        </div>
    </div>

    <!-- Right: Info -->
    <div class="col-12 col-lg-6">
        <h1 class="display-6 fw-semibold mb-1">@Model.Name</h1>

        <div class="mb-3 d-flex gap-2 align-items-center">
            @if (!string.IsNullOrWhiteSpace(Model.Category))
            {
                <span class="badge text-bg-secondary">@Model.Category</span>
            }
            @if (inStock)
            {
                <span class="badge text-bg-success">In stock: @Model.Stock</span>
            }
            else
            {
                <span class="badge text-bg-danger">Out of stock</span>
            }
        </div>

        <div class="h3 fw-bold mb-3">$@Model.Price.ToString("0.00")</div>

        <div class="mb-3 text-secondary">
            @(!string.IsNullOrWhiteSpace(Model.Description) ? Model.Description : "No description.")
        </div>

        <hr />

        <form id="addToCartForm" method="post" asp-controller="Cart" asp-action="Add" class="d-flex align-items-center gap-3">
            @Html.AntiForgeryToken()
            <input type="hidden" name="productId" value="@Model.Id" />
            <div>
                <label class="form-label mb-1">Quantity</label>
                <input type="number" name="qty" value="1" min="1" max="@(Math.Max(1, Model.Stock))"
                       class="form-control" style="max-width:120px" @(inStock ? null : "disabled") />
            </div>

            <button class="btn btn-primary btn-lg" type="submit" @(inStock ? null : "disabled")>
                <i class="bi bi-cart-plus me-1"></i> Add to cart
            </button>
        </form>

        <div id="addMsg" class="alert alert-success mt-3 d-none" role="alert">
            Added to cart. <a asp-controller="Cart" asp-action="ViewCart" class="alert-link">View cart</a>.
        </div>

        <div class="mt-4">
            <a class="btn btn-outline-secondary" asp-controller="Shop" asp-action="Index">
                ← Back to Shop
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
          const form = document.getElementById('addToCartForm');
          if(!form) return;

          form.addEventListener('submit', async function(e){
            // Allow submit normally if user hold Ctrl (go to cart)
            if (e.ctrlKey) return;

            e.preventDefault();
            try {
              const res = await fetch(form.action, { method:'POST', body:new FormData(form) });
              const data = await res.json();   // kỳ vọng JSON { ok: true, count: n }
              if (data && data.ok) {
                const badge = document.getElementById('cart-count');
                if (badge) badge.innerText = data.count ?? badge.innerText;
                const box = document.getElementById('addMsg');
                if (box) box.classList.remove('d-none');
                return;
              }
            } catch {
              window.location = '@Url.Action("ViewCart", "Cart")';
            }
          });
        })();
    </script>
}
